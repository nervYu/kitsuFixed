import{a as m,m as n,b as u,aZ as _,n as l,aH as g,a8 as v,aA as f,ak as r,a_ as c,a$ as M,b0 as b,b1 as $,b2 as k,a9 as y,b3 as q,B as w,C as x,J as L,b4 as S,w as C,d as I,z as h,o as T,A as Q}from"./index-d0b155bb.js";const P={name:"quota-shot-list",components:{TableInfo:m},data(){return{projectNames:{}}},props:{shots:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isLoadingError:{type:Boolean,default:!1},countMode:{type:String,default:"frames"}},computed:{...n(["currentProduction","lastProductionScreen","taskTypeMap"])},methods:{...u([]),getQuota(a){return this.countMode==="seconds"?_(a.nb_frames,this.currentProduction,a):a.nb_frames}},watch:{}};var D=function(){var t=this,e=t._self._c;return e("div",{staticClass:"data-list"},[t.isLoading?t._e():e("table",{staticClass:"details table"},[e("thead",[e("tr",[e("th",[t._v(t._s(t.$t("quota.details_name")))]),e("th",[t._v(" "+t._s(this.countMode==="seconds"?t.$t("quota.details_seconds"):t.$t("quota.details_frames"))+" ")]),e("th",[t._v(t._s(t.$t("quota.weight")))])])]),e("tbody",t._l(t.shots,function(s){return e("tr",{key:`shot-quota-${s.id}`},[e("td",[t._v(t._s(s.full_name))]),e("td",[t._v(t._s(t.getQuota(s)))]),e("td",[t._v(t._s(s.weight))])])}),0)]),e("table-info",{attrs:{"is-loading":t.isLoading,"is-error":t.isLoadingError}})],1)},R=[],N=l(P,D,R,!1,null,"e2523a7b",null,null);const Y=N.exports;const O={name:"shot-quota-info",components:{XIcon:g,PageTitle:v,PeopleAvatar:f,QuotaShotList:Y},props:{person:{type:Object,default:()=>{}},year:{type:Number,default:0},month:{type:Number,default:0},week:{type:Number,default:0},day:{type:Number,default:0},countMode:{type:String,default:"frames"},isLoading:{type:Boolean,default:!1},isLoadingError:{type:Boolean,default:!1},shots:{type:Array,default:()=>[]}},computed:{...n(["currentEpisode","currentProduction"]),startDay(){return r().day("Monday").year(this.year).week(this.week).date()},endDay(){return r().day("Monday").year(this.year).week(this.week).add("days",6).date()},weekMonth(){return r().day("Monday").year(this.year).week(this.week).format("MMM")},monthString(){return c(this.month)},isMonthInfo(){return this.$route.path.indexOf("month")>0},isWeekInfo(){return this.$route.path.indexOf("week")>0},isDayInfo(){return this.$route.path.indexOf("day")>0},closeRoute(){if(!this.currentProduction)return{};let a={name:"quota",production_id:this.currentProduction.id};return this.isMonthInfo?a={name:"quota-month",params:{year:this.year}}:this.isWeekInfo?a={name:"quota-week",params:{year:this.year}}:this.isDayInfo&&(a={name:"quota-day",params:{year:this.year,month:this.month}}),this.currentEpisode&&(a.name=`episode-${a.name}`,a.params.episode_id=this.currentEpisode.id),a}},methods:{...u([]),onCloseClicked(){this.$emit("close")}}};var E=function(){var t=this,e=t._self._c;return e("div",{staticClass:"people-timesheet-info"},[e("div",{staticClass:"close"},[e("router-link",{staticClass:"close-button",attrs:{to:t.closeRoute}},[e("x-icon")],1)],1),e("div",{staticClass:"flexrow"},[e("people-avatar",{staticClass:"flexrow-item",attrs:{person:t.person,"no-cache":!0}}),e("page-title",{staticClass:"flexrow-item",attrs:{text:t.person.full_name}})],1),t.isMonthInfo?e("div",{staticClass:"info-date"},[t._v(" "+t._s(t.monthString)+" "+t._s(t.year)+" ")]):t.isWeekInfo?e("div",{staticClass:"info-date"},[t._v(" week "+t._s(t.week)+", "+t._s(t.startDay)+" - "+t._s(t.endDay)+" "+t._s(t.weekMonth)+" "+t._s(t.year)+" ")]):t.isDayInfo?e("div",{staticClass:"info-date"},[t._v(" "+t._s(t.day)+" "+t._s(t.monthString)+" "+t._s(t.year)+" ")]):t._e(),e("quota-shot-list",{staticClass:"time-spent-list",attrs:{"count-mode":t.countMode,shots:t.shots,"is-loading":t.isLoading,"is-error":t.isLoadingError}})],1)},W=[],A=l(O,E,W,!1,null,"b23213d3",null,null);const F=A.exports;const X={name:"quota",components:{PeopleAvatar:f,TableInfo:m},props:{taskTypeId:{type:String,required:!0},detailLevel:{type:String,default:"day",required:!0},countMode:{type:String,default:"frames",required:!0},computeMode:{type:String,default:"weighted",required:!0},year:{type:Number,default:0},month:{type:Number,default:0},week:{type:Number,default:0},day:{type:Number,default:0},searchText:{type:String,default:""},maxQuota:{default:0}},data(){return{currentMonth:r().month()+1,currentYear:r().year(),currentWeek:r().week(),detailsTitle:"",detailsMap:{},isPanelShown:!1,isLoading:!0,isError:!1,personIds:[],quotaMap:{},quotaLength:0,selected:void 0,averageColumnX:"12rem"}},mounted(){this.shotMap.size<2?(this.isLoading=!0,setTimeout(()=>{this.loadShots(a=>{a||this.loadData()})},100)):(this.isShotsLoading||(this.isLoading=!1),this.loadData())},computed:{...n(["currentEpisode","isShotsLoading","shotMap","personMap"]),monthRange(){return M(this.year,this.currentYear,this.currentMonth)},dayRange(){return b(this.year,this.month,this.currentYear,this.currentMonth)},weekRange(){return $(this.year,this.currentYear,this.currentWeek)},filteredPersonIds(){let a=this.personIds;return this.searchText.length>0&&(a=k(this.personIndex,this.searchText.split(" ")).map(t=>t.id)),a}},methods:{...u(["loadShots","computeQuota","getPeriodDetails"]),episodifyRoute(a){return this.currentEpisode&&y(a,this.currentEpisode.id),a},isWeekend(a,t,e){let s=r(`${a}-${t}-${e}`,"YYYY-MM-DD");return e<10&&(s=r(`${a}-${t}-0${e}`,"YYYY-MM-DD")),[0,6].includes(s.day())},loadData(){this.taskTypeId&&(this.isLoading=!0,this.computeQuota({taskTypeId:this.taskTypeId,detailLevel:this.detailLevel,countMode:this.countMode,computeMode:this.computeMode}).then(a=>{this.quotaMap=a,this.quotaLength=Object.keys(this.quotaMap).length,this.calcAverageColumnX(),this.$nextTick(()=>{this.isLoading=!1})}))},loadDetails(a,t){this.loadShots(e=>{this.isLoading=!0,e?console.error(e):this.taskTypeId&&this.getPeriodDetails({taskTypeId:this.taskTypeId,detailLevel:this.detailLevel,personId:a,dateString:t}).then(s=>{this.detailsMap=s})})},monthToString:c,dateDigit(a){return a.toString().padStart(2,"0")},getQuota(a,t={}){if(t.day){const e=`${t.year}-${this.dateDigit(t.month)}-${this.dateDigit(t.day)}`;return this.quotaMap[a].day[this.countMode][e]}else if(t.week){const e=`${t.year}-${t.week}`;return this.quotaMap[a].week[this.countMode][e]}else{const e=`${t.year}-${this.dateDigit(t.month)}`;return this.quotaMap[a].month[this.countMode][e]}},getQuotaAverage(a,t={}){let e=0,s=0,o;if(this.detailLevel==="day"){const i=`${t.year}-${this.dateDigit(t.month)}`;s=this.quotaMap[a].month[this.countMode][i],o=this.quotaMap[a].day.entries[i]}else if(this.detailLevel==="week"){const i=t.year;s=this.quotaMap[a].year[this.countMode][i],o=this.quotaMap[a].week.entries[i]}else if(this.detailLevel==="month"){const i=t.year;s=this.quotaMap[a].year[this.countMode][i],o=this.quotaMap[a].month.entries[i]}return e=s/o,e?e.toFixed(2):"-"},isDaySelected(a,t,e,s){return this.$route.params.person_id&&this.$route.params.person_id===a&&""+this.$route.params.year==""+t&&""+this.$route.params.month==""+e&&""+this.$route.params.day==""+s},isWeekSelected(a,t,e){return this.$route.params.person_id&&this.$route.params.person_id===a&&""+this.$route.params.year==""+t&&""+this.$route.params.week==""+e},isMonthSelected(a,t,e){return this.$route.params.person_id&&this.$route.params.person_id===a&&""+this.$route.params.year==""+t&&""+this.$route.params.month==""+e},isDayQuotaLow(a,t,e,s){const o=this.getQuota(a,{year:t,month:e,day:s});return o!==null&&this.maxQuota>o},isWeekQuotaLow(a,t,e){return this.maxQuota>this.getQuota(a,{year:t,week:e})},isMonthQuotaLow(a,t,e){return this.maxQuota>this.getQuota(a,{year:t,month:e})},calcAverageColumnX(){this.quotaLength>0&&(this.averageColumnX=`${this.$refs.rowHeaderName.offsetWidth}px`)},resetPersonIds(){const a=Object.keys(this.quotaMap),t=a.map(e=>this.personMap.get(e));this.personIndex=q(t),this.personIds=a.sort((e,s)=>{const o=this.personMap.get(e).full_name,i=this.personMap.get(s).full_name;return o.localeCompare(i)})}},watch:{$route(){document.getElementsByClassName("selected").length===0&&setTimeout(()=>{this.$refs.body.scrollLeft+=380},100)},computeMode(){this.taskTypeId&&this.loadData()},quotaMap(){this.resetPersonIds()},taskTypeId(){this.taskTypeId&&this.loadData()}}};var B=function(){var t=this,e=t._self._c;return e("div",{staticClass:"data-list"},[e("div",{ref:"body",staticClass:"datatable-wrapper"},[e("table",{staticClass:"datatable"},[e("thead",{staticClass:"datatable-head"},[e("tr",[e("th",{ref:"rowHeaderName",staticClass:"name datatable-row-header",attrs:{scope:"col"}},[t._v(" "+t._s(t.$t("quota.name"))+" ")]),e("th",{staticClass:"average datatable-row-header",style:{left:t.averageColumnX},attrs:{scope:"col"}},[t._v(" "+t._s(t.$t("quota.average"))+" ")]),t._l(t.monthRange,function(s){return t.detailLevel==="month"?e("th",{key:"month-"+s,attrs:{scope:"col"}},[t._v(" "+t._s(t.monthToString(s))+" ")]):t._e()}),t._l(t.weekRange,function(s){return t.detailLevel==="week"?e("th",{key:"week-"+s,attrs:{scope:"col"}},[t._v(" "+t._s(s)+" ")]):t._e()}),t._l(t.dayRange,function(s){return t.detailLevel==="day"?e("th",{key:"day-"+s,attrs:{scope:"col"}},[t._v(" "+t._s(s)+" ")]):t._e()})],2)]),this.quotaLength>0&&!t.isLoading?e("tbody",{staticClass:"datatable-body"},t._l(t.filteredPersonIds,function(s){return e("tr",{key:"name-"+s,staticClass:"datatable-row"},[e("th",{staticClass:"name datatable-row-header",attrs:{scope:"row"}},[e("div",{staticClass:"flexrow"},[e("people-avatar",{attrs:{size:30,person:t.personMap.get(s)}}),t._v(" "+t._s(t.personMap.get(s).full_name)+" ")],1)]),t.detailLevel==="month"?e("td",{staticClass:"average datatable-row-header",style:{left:t.averageColumnX}},[t._v(" "+t._s(t.getQuotaAverage(s,{year:t.year}))+" ")]):t._e(),t.detailLevel==="week"?e("td",{staticClass:"average datatable-row-header",style:{left:t.averageColumnX}},[t._v(" "+t._s(t.getQuotaAverage(s,{year:t.year}))+" ")]):t._e(),t.detailLevel==="day"?e("td",{staticClass:"average datatable-row-header",style:{left:t.averageColumnX}},[t._v(" "+t._s(t.getQuotaAverage(s,{year:t.year,month:t.month}))+" ")]):t._e(),t._l(t.monthRange,function(o){return t.detailLevel==="month"?e("td",{key:"month-"+o,class:{selected:t.isMonthSelected(s,t.year,o),"quota-low":t.isMonthQuotaLow(s,t.year,o)}},[t.getQuota(s,{year:t.year,month:o})?e("router-link",{staticClass:"quota-button",attrs:{to:t.episodifyRoute({name:"quota-month-person",params:{person_id:s,year:t.year,month:o}})}},[t._v(" "+t._s(t.countMode==="seconds"?t.getQuota(s,{year:t.year,month:o}).toFixed(2):t.getQuota(s,{year:t.year,month:o}))+" ")]):e("span",[t._v("-")])],1):t._e()}),t._l(t.weekRange,function(o){return t.detailLevel==="week"?e("td",{key:"week-"+o,class:{selected:t.isWeekSelected(s,t.year,o),"quota-low":t.isWeekQuotaLow(s,t.year,t.month)}},[t.getQuota(s,{year:t.year,week:o})?e("router-link",{staticClass:"quota-button",attrs:{to:t.episodifyRoute({name:"quota-week-person",params:{person_id:s,year:t.year,week:o}})}},[t._v(" "+t._s(t.countMode==="seconds"?t.getQuota(s,{year:t.year,week:o}).toFixed(2):t.getQuota(s,{year:t.year,week:o}))+" ")]):e("span",[t._v(" - ")])],1):t._e()}),t._l(t.dayRange,function(o){return t.detailLevel==="day"?e("td",{key:"day-"+o,class:{weekend:t.isWeekend(t.year,t.month,o),selected:t.isDaySelected(s,t.year,t.month,o),"quota-low":t.isDayQuotaLow(s,t.year,t.month,o)}},[t.getQuota(s,{year:t.year,month:t.month,day:o})?e("router-link",{staticClass:"quota-button",attrs:{to:t.episodifyRoute({name:"quota-day-person",params:{person_id:s,year:t.year,month:t.month,day:o}})}},[t._v(" "+t._s(t.countMode==="seconds"?t.getQuota(s,{year:t.year,month:t.month,day:o}).toFixed(2):t.getQuota(s,{year:t.year,month:t.month,day:o}))+" ")]):e("span",[t._v(" - ")])],1):t._e()})],2)}),0):t._e()])]),this.quotaLength===0&&!t.isLoading?e("div",{staticClass:"has-text-centered empty-quota"},[e("p",{staticClass:"info"},[t._v(t._s(t.$t("quota.no_quota")))])]):t._e(),e("table-info",{attrs:{"is-loading":t.isLoading,"is-error":t.isError}})],1)},j=[],K=l(X,B,j,!1,null,"643c6840",null,null);const z=K.exports;const H={name:"production-quota",components:{ButtonSimple:w,Combobox:x,ComboboxTaskType:L,InfoQuestionMark:S,PeopleQuotaInfo:F,Quota:z,SearchField:C,TextField:I},data(){return{taskTypeId:"",countMode:"frames",countModeOptions:[{label:this.$t("quota.frames"),value:"frames"},{label:this.$t("quota.seconds"),value:"seconds"},{label:this.$t("quota.count"),value:"count"}],detailLevelOptions:[{label:this.$t("quota.day"),value:"day"},{label:this.$t("quota.week"),value:"week"},{label:this.$t("quota.month"),value:"month"}],computeModeOptions:[{label:this.$t("quota.weighted"),value:"weighted"},{label:this.$t("quota.feedback_date"),value:"feedback"}],computeMode:"weighted",currentYear:r().year(),currentMonth:r().month()+1,currentWeek:r().week(),currentDay:r().date(),currentPerson:this.getCurrentPerson(),currentMode:"frames",detailLevelString:"day",detailLevel:"day",isLoading:!1,isLoadingError:!1,isPersonShotsLoading:!1,maxQuota:0,monthString:`${r().month()+1}`,personShots:[],searchText:"",showInfo:!1,yearString:`${r().year()}`}},mounted(){this.loadRoute()},computed:{...n(["currentEpisode","currentProduction","productionShotTaskTypes","shotTaskTypes","personMap"]),yearOptions(){const t=r().year();return h(2018,t).map(e=>({label:e,value:`${e}`}))},monthOptions(){const a=`${r().year()}`,t=1,e=r().month()+1;let s=h(t,12);return a===this.yearString&&(s=h(t,e)),s.map(o=>({label:c(o),value:`${o}`}))}},methods:{...u(["getPersonQuotaShots","loadShots"]),getCurrentPerson(){const a=this.$route.params.person_id;return a&&this.personMap?this.personMap.get(a):{}},loadRoute(){const{month:a,year:t,week:e,day:s}=this.$route.params,{countMode:o,taskTypeId:i,computeMode:p}=this.$route.query;if(this.$route.path.indexOf("week")>0&&(this.detailLevel="week"),this.$route.path.indexOf("month")>0&&(this.detailLevel="month"),this.$route.path.indexOf("day")>0&&(this.detailLevel="day"),this.currentPerson=this.getCurrentPerson(),this.detailLevelString=this.detailLevel,o&&(this.countMode=o,this.currentMode=this.countMode),i)this.taskTypeId=i;else{const d=`quota:${this.currentProduction.id}:task-type-id`;this.taskTypeId=localStorage.getItem(d)||this.shotTaskTypes[0].id}p&&(this.computeMode=p),a&&(this.currentMonth=Number(a),this.monthString=`${a}`),t&&(this.currentYear=Number(t),this.yearString=`${t}`),e&&(this.currentWeek=Number(e),this.weekString=`${e}`),s&&(this.currentDay=Number(s)),this.$route.path.indexOf("person")>0?(this.isPersonShotsLoading=!0,this.getPersonQuotaShots({personId:this.currentPerson.id,detailLevel:this.detailLevel,taskTypeId:this.taskTypeId,year:t,month:a,week:e,day:s,computeMode:this.computeMode}).then(d=>{this.isPersonShotsLoading=!1,this.personShots=d,this.showSideInfo()})):this.hideSideInfo()},showSideInfo(){this.showInfo=!0},hideSideInfo(){this.showInfo=!1},episodifyRoute(a){return this.currentEpisode&&y(a,this.currentEpisode.id),a},exportQuotas(){const a=this.$refs["quota-list"].quotaMap,t=["quotas",this.detailLevel,this.currentYear];this.detailLevel==="day"&&t.push(this.currentMonth);const e=T.slugify(t.join("_")),s=Object.keys(a).map(o=>this.personMap.get(o)).sort((o,i)=>o.full_name.localeCompare(i.full_name));Q.generateQuotas(e,a,s,this.countMode,this.detailLevel,r().year(),r().month()+1,this.currentYear,this.currentMonth,this.currentWeek)},onSearchChange(a){this.searchText=a}},watch:{detailLevelString(){if(this.detailLevel!==this.detailLevelString){const a={name:`quota-${this.detailLevelString}`,params:{year:this.currentYear},query:{countMode:this.countMode,computeMode:this.computeMode}};this.detailLevelString==="day"&&(a.params.month=this.currentMonth),this.$router.push(this.episodifyRoute(a))}},yearString(){const a=Number(this.yearString),t=r().month()+1;if(this.currentYear!==a){const e={name:`quota-${this.detailLevelString}`,params:{year:a},query:{countMode:this.countMode,computeMode:this.computeMode}};this.detailLevelString==="day"&&(e.params.month=`${Math.min(Number(this.monthString),t)}`),this.$router.push(this.episodifyRoute(e))}},monthString(){if(this.currentMonth!==Number(this.monthString)){const a={name:"quota-day",params:{year:this.currentYear,month:Number(this.monthString)},query:{countMode:this.countMode,computeMode:this.computeMode}};this.$router.push(this.episodifyRoute(a))}},countMode(){this.currentMode!==this.countMode&&(this.$route.query.countMode!==this.countMode&&this.$router.push({query:{countMode:this.countMode,computeMode:this.computeMode}}),this.currentMode=this.countMode)},computeMode(){this.$route.query.computeMode!==this.computeMode&&this.$router.push({query:{computeMode:this.computeMode}})},taskTypeId(){const a=`quota:${this.currentProduction.id}:task-type-id`;localStorage.setItem(a,this.taskTypeId),this.$route.query.taskTypeId!==this.taskTypeId&&this.$router.push({query:{taskTypeId:this.taskTypeId}})},currentProduction(){this.isLoading=!0,this.loadShots(()=>{this.loadRoute(),this.isLoading=!1})},currentEpisode(){this.isLoading=!0,this.loadShots(()=>{this.loadRoute(),this.isLoading=!1})},$route(){this.loadRoute()}}};var G=function(){var t=this,e=t._self._c;return e("div",{staticClass:"columns fixed-page"},[e("div",{staticClass:"column main-column"},[e("div",{staticClass:"flexrow filters"},[e("div",{staticClass:"flexrow-item"},[e("combobox-task-type",{staticClass:"flexrow-item",attrs:{label:t.$t("quota.type_label"),"task-type-list":t.productionShotTaskTypes},model:{value:t.taskTypeId,callback:function(s){t.taskTypeId=s},expression:"taskTypeId"}})],1),e("div",{staticClass:"flexrow-item"},[e("combobox",{staticClass:"flexrow-item",attrs:{label:t.$t("quota.detail_label"),options:t.detailLevelOptions},model:{value:t.detailLevelString,callback:function(s){t.detailLevelString=s},expression:"detailLevelString"}})],1),t.detailLevelString==="day"?e("combobox",{staticClass:"flexrow-item",attrs:{label:t.$t("quota.month_label"),options:t.monthOptions},model:{value:t.monthString,callback:function(s){t.monthString=s},expression:"monthString"}}):t._e(),e("combobox",{staticClass:"flexrow-item",attrs:{label:t.$t("quota.year_label"),options:t.yearOptions},model:{value:t.yearString,callback:function(s){t.yearString=s},expression:"yearString"}}),e("div",{staticClass:"flexrow-item"},[e("combobox",{staticClass:"flexrow-item",attrs:{label:t.$t("quota.count_label"),options:t.countModeOptions},model:{value:t.countMode,callback:function(s){t.countMode=s},expression:"countMode"}})],1),e("combobox",{staticClass:"flexrow-item",attrs:{label:t.$t("quota.compute_mode"),options:t.computeModeOptions},model:{value:t.computeMode,callback:function(s){t.computeMode=s},expression:"computeMode"}}),e("div",{staticClass:"flexrow-item"},[e("info-question-mark",{staticClass:"mt2",attrs:{text:t.computeMode==="weighted"?t.$t("quota.explaination"):t.$t("quota.explaination_feedback")}})],1),e("div",{staticClass:"filler"}),e("button-simple",{staticClass:"flexrow-item",attrs:{title:t.$t("quota.export_quotas"),icon:"download"},on:{click:t.exportQuotas}})],1),e("div",{staticClass:"flexrow mb2 mt0"},[e("search-field",{ref:"search-field",staticClass:"search-field flexrow-item",on:{change:t.onSearchChange}}),e("span",{staticClass:"label flexrow-item"},[t._v(" "+t._s(t.$t("quota.highlight_quotas"))+" ")]),e("text-field",{staticClass:"flexrow-item max-quota-input",attrs:{type:"number"},model:{value:t.maxQuota,callback:function(s){t.maxQuota=s},expression:"maxQuota"}})],1),e("quota",{ref:"quota-list",attrs:{taskTypeId:t.taskTypeId,detailLevel:t.detailLevelString,year:t.currentYear,month:t.currentMonth,week:t.currentWeek,day:t.currentDay,currentPerson:t.currentPerson,countMode:t.currentMode,computeMode:t.computeMode,searchText:t.searchText,maxQuota:t.maxQuota}})],1),t.showInfo?e("div",{staticClass:"column side-column"},[e("people-quota-info",{attrs:{person:t.currentPerson,year:t.currentYear,month:t.currentMonth,week:t.currentWeek,day:t.currentDay,"is-loading":t.isPersonShotsLoading,"is-loading-error":!1,shots:t.personShots,"count-mode":t.countMode},on:{close:t.hideSideInfo}})],1):t._e()])},J=[],Z=l(H,G,J,!1,null,"1185db6a",null,null);const V=Z.exports;export{V as default};
//# sourceMappingURL=ProductionQuota-c6480c08.js.map
